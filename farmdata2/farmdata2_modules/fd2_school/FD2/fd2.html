<html>
<body>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="main.css">
    <style>
        [v-cloak] {
          display:none;
        }

        table, th, td { 
          border: 1px solid black; 
          border-collapse: collapse; 
          } 

    </style> 
</head>

<h1 data-cy="page-header">Harvest Report</h1>
<p><FONT COLOR="GREY"> This page is a <i>mockup</i> of a simplfied Harvest Report</FONT></p>
<div id="pageInfo">
    <input type="text" value="Title:" v-model="rHeader"/>
    <body>
    <br>
    
    <label for="crop">Crop:</label> 
    <dropdown-with-all data-cy="crop-dropdown" 
            includes-all 
            :selected-val='selectedCrop'
            :dropdown-list='cropNames'
            @selection-changed="cropChange">
        </dropdown-with-all>


    <br>
    <label for="field">Field:</label>
    <select id="field" v-model="selectedArea"> 
      <option v-for="area in areas" :value="area">{{ area }}</option>
    </select>
    <br>
    <label for="start">Start date:</label>

    <div id="startDate">
    <input data-cy="start-date" type="date" id="start" min="minStartDate" :max="rEndDate" v-model="rStartDate"/>        
    </div>

    <br>
    <label for="end">End date:</label>
    <input data-cy="end-date" type="date" id="end" :min="rStartDate" max="maxEndDate" v-model="rEndDate"/>
    <br>
    <button data-cy="report-button" class="btn btn-primary" @click="saveReport" type="submit">Generate Report</button>
    
    <hr style="width:33%;margin-left:0">
    <div id="rHeader">
    <h1 data-cy="report-title">{{ (rHeaderInput!="") ? rHeader:"Mock Harvest Report"}}</h1>
    <p><FONT COLOR="GREY"> Details:</FONT></p>
    <ul>
      <li data-cy="farm-name"><b>Farm:</b> {{ Farm }}</li>
      <li data-cy="user-name"><b>User:</b> {{ User }}</li>
      <li><b>Language:</b> <span data-cy="language-check"> {{ Language }} </span> </li>
    <br>
      <li><b>Start:</b> {{ rStartDate }}</li>
      <li><b>End:</b> {{ rEndDate }}</li>
      <li><b>Crop:</b> {{ selectedCrop }}</li>
    </ul>
    </div>
    <h3 v-if="tableData.length === 0"> No records to display </h3>
    <ul>
      <custom-table data-cy="report table"
        :columns="columns"
        :rows="harvestReportRows">
      </custom-table>
    </ul>
</div>



</body>
<script>
  var pageInfo = new Vue({
      el: '#pageInfo',
      data: {
          rHeader: "",
          rHeaderInput: "",
          rStartDate: "2020-05-05",
          minStartDate: "2014-01-01",
          maxStartDate: "2022-01-01",
          rEndDate:"2020-05-15",
          minEndDate:"2020-05-05",
          maxEndDate:"2022-01-01",
          rStartTimestamp:"",
          rEndTimestamp:"",
          APIAllPageData:[
          ],

          idToCropMap: new Map(),
          
          selectedCrop: "All",
          
          areas: [
            "All",
            "Chuau-1",
            "SQ7",
          ],
          selectedArea: "",

          Farm: "",
          User: "",
          Language: "",

          newData:'',

          tableData: [
            
          ],

          columns: [
            {"header": "Date", "visible": true, "inputType":{"type":"no input"}},
            {"header": "Area", "visible": true, "inputType":{"type":"no input"}},
            {"header": "Crop", "visible": true, "inputType":{"type":"no input"}},
            {"header": "Yield", "visible": true, "inputType":{"type":"no input"}},
            {"header": "Units", "visible": true, "inputType":{"type":"no input"}},
          ]

        },

        created() {
	        getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap=theMap
            })

            .catch((err) => {
                console.log("error IDToCropMap")
            })
        },

        computed: {
            cropNames(){
                return Array.from(this.idToCropMap.values());
            },

            harvestReportRows() {
	            let tableRows = []
	            for(let log of this.APIAllPageData) {
                  let tableRow = {
                    id: log.data.crop_tid,
                    data:[
                      dayjs.unix(log.timestamp).format('MM/DD/YYYY'),
                      log.area[0].name,
                      this.idToCropMap.get(log.data.crop_tid), 
                      log.quantity[0].value,                   
                      log.quantity[0].unit.name,                   
                    ],
                }
                if(this.selectedCrop == "All"){
                tableRows.push(tableRow)
		            }
                else if(tableRow.data[2] == this.selectedCrop){
                tableRows.push(tableRow)
		            }
	            }
	            return tableRows
            },
            
        },

        components: {
        'dropdown-with-all': DropdownWithAllComponent,
        "custom-table": CustomTableComponent,
        },


        methods: {

          cropChange(newCrop) {
            this.selectedCrop = newCrop
          },


          saveReport: function(){
              axios.get('/farm.json')
              .then ((response) => {
                this.Farm=response.data.name;
                this.User=response.data.user.name;
                this.Language=response.data.languages.en.name;
              })
              .catch ((error) => {
                console.log("Error Occurred")
                console.log(error)
              })

              this.rHeaderInput = this.rHeader;
              let rStartTimestamp = dayjs(this.rStartDate).unix();
              let rEndTimestamp = dayjs(this.rEndDate).unix();

              this.tableData.push({index: 0,date:"", area: "", crop: "",yield:"",units: ""}),     
              
              getAllPages("/log.json?type=farm_harvest&timestamp[ge]=" + rStartTimestamp + "&timestamp[le]=" + rEndTimestamp)
              .then((res) => {
                this.APIAllPageData=res
              })
              .catch((err) => {
                console.log("Error Occurred")
                console.log(err)
              })

            },  
      } 
  });
  Vue.config.devtools = true;
</script>
</body>
</html>

