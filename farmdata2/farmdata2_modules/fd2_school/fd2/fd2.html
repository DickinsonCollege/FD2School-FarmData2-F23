<html> 
<h1 data-cy="page-header">Harvest Report</h1>
    <div id="sample-report" v-cloak>
        <body>
            <p>This page is a simple <i>mockup</i> of a simplified harvest report.</p>
            <br>
            <p>
                <label for="title">Title:</label>
                <input type="text" v-model="title"/>
            </p>
            <br>
            <p>
                <label for="startDate">Start:</label>
                <input data-cy="start-date" type="date" id="startDate" name="startDate" min="2014-01-01" :max="endDate" v-model="startDate"/>
                <label for="endDate">End:</label>
                <input data-cy="end-date" type="date" id="endDate" name="endDate" :min="startDate" max="2022-01-01" v-model="endDate"/>
            </p>
            <br>
            <p>
                <label for="crop">Crop:</label>
                <dropdown-with-all id="crop" name="crop" v-model="crop" data-cy="crop-selection" 
                    includes-all 
                    :selected-val='crop'
                    :dropdown-list='cropNames'
                    @selection-changed="cropChange"
                >
                </dropdown-with-all>  
                <label for="field">Area:</label>
                <select id="field" name="field" v-model="area">
                    <option v-for="area in areas">{{ area }}</option>
                </select>
            </p>
            <br>
            <button data-cy="Generate-Report-Button" type="generate" @click='genReport'>Generate Report</button>
        </body>
    <hr>
        <h1 data-cy="title">{{ title == '' ? 'Mock Harvest Report':title}}</h1>
            <body> 
                <p>Details:
                    <ul>
                        <li data-cy="farm"><strong>Farm: </strong>{{ Farm }}</li>
                        <li data-cy="username"><strong>User: </strong>{{ User }}</li>
                        <li><strong>Language: </strong><span data-cy="language">{{ Language }}</span></li>
                        <br>
                        <li><strong>Start: </strong>{{ startDate }}</li>
                        <li><strong>End: </strong>{{ endDate }}</li>
                        <li><strong>Crop: </strong>{{ crop }}</li>
                    </ul>
                </p>
                <br>
                <p v-if="harvestReportRows.length === 0">No Harvest Report Records Match</p>
                <table border="1" v-if="harvestReportRows.length > 0">
                    <tr>
                        <th><strong>Row</strong></th>
                        <th><strong>Date</strong></th>
                        <th><strong>Area</strong></th>
                        <th><strong>Crop</strong></th>
                        <th><strong>Yield</strong></th>
                        <th><strong>Units</strong></th>
                    </tr>
                    <tr v-for="(row,index) in harvestReportRows">
                        <td>{{ index + 1}}</td>
                        <td>{{ row.date }}</td>
                        <td>{{ row.area }}</td>
                        <td>{{ row.crop }}</td>
                        <td>{{ row.yield }}</td>
                        <td>{{ row.units }}</td>
                    </tr>
                </table>
            </body>
    </div>
    <script>
        var sampleHarvestReport = new Vue ({
            created() {
	            console.log("HarvestReport Vue instance created!")
                getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap = theMap;
                })
                .catch((err) => {
                    console.log("Error occurred!")
                })
            },
            el: '#sample-report',
            components: {
                'dropdown-with-all': DropdownWithAllComponent,
            },
            data: {
                title: '',
                Farm: '',
                User: '',
                Language: '',
                startDate: '2020-05-05',
                endDate: '2020-05-15',
                crop: 'All',
                idToCropMap: new Map(),
                area: 'All',
                areas: [
                    'All',
                    'Chuau-1',
                    'SQ7'
                ],
                newLog: {},
                harvestLogs: [
                ],
                allHarvestLogs: [

                ],
            },
            computed: {
                cropNames () {
                    return Array.from(this.idToCropMap.values());
                },
                harvestReportRows() {
                let tableRows = []
                    for(let log of this.allHarvestLogs) { 
                        if(this.idToCropMap.get(log.data.crop_tid) === this.crop) {   
                            let tableRow = {
                                date: dayjs.unix(log.timestamp).format('MM/DD/YYYY'),
                                area: log.area[0].name,
                                yield: log.quantity[0].value,
                                units: log.quantity[0].unit.name,
                                crop: this.idToCropMap.get(log.data.crop_tid)
                            }
                            tableRows.push(tableRow)
                        }
                    }
                    return tableRows
                },
            },
            methods: {
                genReport: function() {
                    axios.get('/farm.json')
                    .then((response) => {
                        this.Farm = response.data.name;
                        this.User = response.data.user.name;
                        this.Language = response.data.languages.en.name;
                    })
                    .catch((error) => {
                        console.log("Error occurred");
                        console.log(error);
                    })
                    
                    let startTimestamp = dayjs(this.startDate).unix();
                    let endTimestamp = dayjs(this.endDate).unix();
                    
                    getAllPages('/log.json?type=farm_harvest&timestamp[ge]=' + startTimestamp + '&timestamp[le]=' + endTimestamp, this.allHarvestLogs)
                    .then(() => {

                    })
                    .catch((err) => {
                        console.log("Error occurred");
                        console.log(error);
                    })
                },
                cropChange(newCrop) {
                this.crop = newCrop
                },
            }
        })
        Vue.config.devtools = true;
    </script>
<hr>
</html>