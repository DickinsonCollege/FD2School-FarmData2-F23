<h1 data-cy="page-header">Harvest Report</h1>
<p>This page is a <i>mockup</i> of a simplified harvest report</p>
<div id = Vue2 v-cloak>
    <label for="title">Title</label>
    <input type="text" v-model="rptTitle">
    <br><br>
    
    <label for="start">Start:</label>
    <input data-cy="start-date" type="date" v-model = "rptStartDate" :max="rptEndDate" />
    
    <label for="end">End:</label>
    <input data-cy="end-date" type="date" v-model = "rptEndDate" :min="rptStartDate" /> 
    
    <br><br>
    <label for="rptCrop">Crop</label> 
    <dropdown-with-all  v-model="rptCrop" data-cy="crop-dropdown" 
        includes-all
        :selected-val="rptCrop"
        :dropdown-list="cropNames"
        @selection-changed="cropChange" 
    >
    </dropdown-with-all>

    <label for="rptField">Area</label>
    <select v-model="rptField">
        <option v-for="field in fields">{{field}}</option>
    </select>
    
    <br><br>
    <button data-cy="generate-report-button" type="button" v-on:click="savehstLogs">Generate Report</button>
    
    <hr>
    <h1 data-cy="report-title">{{rptTitle==""? "Mock Harvest Report":rptTitle}}</h1>


<p>
    Details:
    <ul>
        <li data-cy="farm-name"><b>Farm</b>:{{farm}}</li>
        <li data-cy="user-name"><b>User</b>:{{user}}</li>
        <li><b>Language</b>:<span data-cy="language">{{language}}</span></li>
        <br> 
        <li><b>Start</b>:{{rptStartDate}}</li>
        <li><b>End</b>:{{rptEndDate}}</li>
        <li><b>Crop</b>:{{rptCrop}}</li>
     </ul>
    </p>

    <div v-if="harvestReportRows.length > 0">      
        <table border="1">
            <tr>
                <th>Row</th>
                <th>Date</th>
                <th>Area</th>
                <th>Crop</th>
                <th>Yield</th>
                <th>Units</th>
            </tr>
            <tr v-for="log in harvestReportRows">
                <td>{{log.row}}</td>
                <td>{{log.date}}</td>
                <td>{{log.area}}</td>
                <td>{{log.crop}}</td>
                <td>{{log.yield}}</td>
                <td>{{log.units}}</td>
            </tr>
        </table>


    </div>
    <div v-else>
        <p>No Matching Records<p>
    </div>

    
        
       
</div>

<script>
    var Vue2 = new Vue({
        el:"#Vue2",
        created(){
            console.log("HarvestReport Vue instance created!")
            getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap
            })
            .catch((err) => {
            })
        },
        data: {
            rptTitle: "My Sample Harvest Report",
            rptStartDate: "2020-05-05",
            rptEndDate: "2020-05-15",
            rptCrop: "All",
            rptField: "All",
            fields: ["All", "Chuau-1", "SQ7"],
            hstLogs: [],
            farm: "",
            user: "",
            language: "",
            idToCropMap: new Map(),
            allLogs: [],
        },
        components: {
        'dropdown-with-all': DropdownWithAllComponent,
        },   
        computed:{
            cropNames(){
                return Array.from(this.idToCropMap.values())
            },
            harvestReportRows(){
                let tableRows = []
                i = 0;
                for (let log of this.allLogs){
                    let tableRow = {
                        row: i += 1,
                        date: dayjs.unix(log.timestamp).format("MM/DD/YYYY"),
                        crop: this.idToCropMap.get(log.data.crop_tid),
                        area: log.area[0].name,
                        yield: log.quantity[0].value ,
                        units: log.quantity[0].unit.name,
                    }

                    if(this.rptCrop == "All"){
                        tableRows.push(tableRow)
                    }
                    else if (this.rptCrop == (tableRow.crop)){
                        tableRows.push(tableRow)
                    }
                }
                return tableRows

            }
        }
        ,
        methods: {
            cropChange(newCrop) {
                this.rptCrop = newCrop
            },
            savehstLogs: function(){
                axios.get("/farm.json")
                .then ((response) => {
                    this.farm = response.data.name
                    this.user = response.data.user.name
                    this.language = response.data.languages.en.name
                })
                .catch((error) => {
                })

                let start = dayjs(this.rptStartDate).unix();
                let end = dayjs(this.rptEndDate).unix();
                request = "/log.json?type=farm_harvest&timestamp[ge]="+ start+"&timestamp[le]="+end;


                getAllPages(request)
                .then((res) => {
                    this.allLogs = res
                })
                .catch((err) => {
                })
 
            }
        }
    })

    Vue.config.devtools = true;
</script>


