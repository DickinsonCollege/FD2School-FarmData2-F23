<body>
    <h1 data-cy="page-header">Harvest Report</h1>
    <p> This page is a <i>mockup</i> of a simplified harvest report.</p>

    <div id="report" v-cloak>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="reportTitle">
        <br/>

        <label for="start">Start:</label>
        <input data-cy="start-date" type="date" id="start" name="start" v-model="reportStartDate" min="2014-01-01" max="2022-01-01" :disabled="reportStartDate > reportEndDate" />
        <label for="end">End:</label>
        <input data-cy="end-date" type="date" id="end" name="end" v-model="reportEndDate" min="2020-05-05" max="2022-01-01" />
        <br/>

        <label for="crop">Crop:</label>
        <dropdown-with-all data-cy="crop-dropdown"
            includes-all 
            :selected-val='reportCrop'
            :dropdown-list='cropNames'
            @selection-changed="cropChange">
            Pick a Crop: 
        </dropdown-with-all>

        <label for="field">Area:</label>
        <select id="field" name="field" v-model="reportField">
            <option v-for="field in reportFields"> {{field}} </option>
        </select>
        <br/>

        <button data-cy="generate-report-button" type="button" @click='generateReport'>Generate Report</button>
        <hr/>


        <h1 data-cy="report-title">{{ reportTitle ? reportTitle : 'Mock Harvest Report' }}</h1>

        <p>Details: </p>
        <ul>
            <li><strong>Farm:</strong><span data-cy="farm-name">{{ farm }}</span></li>
            <li data-cy="user-name"><strong>User:</strong>{{ user }}</li>
            <li><strong>Language:</strong><span data-cy="language">{{ language }}</span></li>
            <br/>
            <li><strong>Start:</strong>{{ reportStartDate }}</li>
            <li><strong>End:</strong>{{ reportEndDate }}</li>
            <li><strong>Crop:</strong>{{ reportCrop }}</li>
        </ul>

        <UL>
            <custom-table data-cy="test-table"
                :columns="columns"
                :rows="harvestReportRows">
            </custom-table>
        </UL>
    </div>
    
    <script>
        var report = new Vue({
            el: '#report',
            components: {
                'dropdown-with-all': DropdownWithAllComponent,
                'custom-table': CustomTableComponent
            },
            created() {
                getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap = theMap
                })
                .catch((err) => {
                    console.log("Error Occurred")
                    console.log(error)
                })  
                console.log("HarvestReport Vue instance created!")
            },
            data: {
                reportTitle: 'My Sample Harvest Report',
                reportStartDate: '2020-05-05',
                reportEndDate: '2020-05-15',
                reportCrop: 'All',
                reportField: 'All',
                reportFields: [
                    'All',
                    'Chuau-1',
                    'SQ7'
                ],
                farm: '',
                user: '',
                language: '',
                idToCropMap: new Map(),
                getAllPagesResult: [],
                columns: [
                    {"header": 'Row', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},
                ]
            },
            computed: {
                cropNames() {
                    return Array.from(this.idToCropMap.values());
                },
                harvestReportRows() {
                    let tableRows = []
                    let counter = 1
                    for(let log of this.getAllPagesResult) {
                        let tableRow = {
                            id: log.id,
                            data: [
                                    counter,
                                    dayjs.unix(log.timestamp).format("YYYY-MM-DD"),
                                    log.area[0].name,
                                    this.idToCropMap.get(log.data.crop_tid),
                                    log.quantity[0].value,
                                    log.quantity[0].unit.name
                                ]
                            }
                        if(tableRow.data[3] == this.reportCrop) {
                            tableRows.push(tableRow)
                            counter = counter + 1
                        }
                        else if(this.reportCrop == "All") {
                            tableRows.push(tableRow)
                            counter = counter + 1
                        }
                    }
                    return tableRows
                }
            },
            methods: {
                generateReport: function() {
                    axios.get('/farm.json')  // this line sends the request.
                    .then((response) => {
                        this.farm = response.data.name
                        this.user = response.data.user.name
                        this.language = response.data.languages.en.name
                        //^^ its pretty much hardcoded to english as of right
                        reportStartDateTimeStamp = dayjs(this.reportStartDate).unix()
                        reportEndDateTimeStamp = dayjs(this.reportEndDate).unix()
                        requestEndpointWithQueryParams = '/log.json?type=farm_harvest&timestamp[ge]=' + reportStartDateTimeStamp + '&timestamp[le]=' + reportEndDateTimeStamp 
                        getAllPages(requestEndpointWithQueryParams)
                        .then((res) => {
                            this.getAllPagesResult = res
                        })
                        .catch((err) => {
                           console.log(err)
                        })
                    })
                    .catch((error) => {
                        console.log("Error Occurred")
                        console.log(error)
                    })
              },
            cropChange(newCrop) {
                this.reportCrop = newCrop
            }
            }
        })
        Vue.config.devtools = true;
    </script>
</body>