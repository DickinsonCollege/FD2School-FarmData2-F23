<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Sub tab</title>
    <h1>Harvest Report</h1>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
    <script src="https://unpkg.com/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7"></script>
</head>
<body>
    <div id="report">
        <br>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
        <label for="reportTitle">Title</label>
        <input type="text" id="reportTitle" value="My Sample Harvest Report" v-model="reportTitle"/>
        <br><br>
        
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" :max="endDate" v-model="startDate" data-cy="start-date">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate" :min="startDate" v-model="endDate" data-cy="end-date">
        <br>
        <br>

        <label for="crops">Crops:</label>
        <UL>

            <dropdown-with-all id="crops" name="crops" v-model="selectedCrop" data-cy="select-crop" includes-all :selected-val="reportCrop" :dropdown-list="cropNames" @selection-changed="cropChange"></dropdown-with-all>
        </UL>
            <label for="area">Area:</label>
            <select id="area" name="area" v-model="selectedArea">
                <option v-for="area in areas">{{area}}</option>
            </select>
            <br>
            <br>
            <input type="button" value="Generate Report" data-cy="generate-button" v-on:click="generateReport"/>

        <hr>
        <div>
            <h1> data-cy="title">{{reportTitle==""?"Mock Harvest Report":reportTitle}}</h1> 
            <p>Details:</p>
            <ul>
                <li data-cy="farm-name"><b>Farm:</b>{{farm}}</li>
                <li data-cy="username"><b>User:</b>{{user}}</li>
                <li><b>Language:</b><span data-cy="language">{{ language }}</span>
            </ul>
            <UL>
                <custom-table data-cy="report-table"
                    :columns="columns"
                    :rows="componentReportRows"
                    >
                </custom-table>
            </UL>
            <br>
            <ul>
                <li><strong>Start:</strong>{{startDate}}</li>
                <li><strong>End:</strong>{{endDate}}</li>
                <li><strong>Crop:</strong>{{selectedCrop}}</li>
            </ul>
            
            <p v-else>No recorded data found.</p>
        </div>
    </div>

    <script>
        var harvestRepo = new Vue({
            el: '#report',
            data: {
                reportTitle: "",
                startDate: '',
                endDate: '',
                selectedCrop: 'All',
                selectedArea: '',
                crops: [],
                areas: ['All', 'Chuau-1', 'SQ7'],
                farmName: '',
                userName: '',
                userLanguage: '',
                idToCropMap: new Map(),
                harvestLogs: [],
                datedLogs: [],
                columns:[
                    {"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
                    {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},
                ],
            },


            components: {
                'dropdown-with-all': DropdownWithAllComponent,
            },

            created() {
                console.log("HarvestReport Vue instance created!");
    
            },

            methods: {
                cropChange(newCrop) {
                    this.reportCrop = newCrop
                },
                generateReport: function() {
                    this.harvestLogs.push({ date:"2020-05-05", area:"Orion-3", crop:"Peas", yield:"12", unit:"Bunches"});
                    axios.get('/farm.json')
                        .then((response) => {

                            this.farmName = response.data.name;
                            this.userName = response.data.user.name;
                            this.userLanguage = response.data.user.language;
                        })
                        .catch((error) => {
                            console.error("Error fetching crops");
                            console.log(error)
                        });

                    let startDateTimestamp = dayjs(this.startDate).unix();
                    let endDateTimestamp = dayjs(this.endDate).unix();
                    console.log("Start Date Timestamp: ", startDateTimestamp);
                    console.log("End Date Timestamp: ", endDateTimestamp);
                    let request = `/log.json?type=farm_harvest&timestamp[ge]=${startDateTimestamp}&timestamp[le]=${endDateTimestamp}`;
                    console.log("API Request: ", request);
                    getAllPages(request, this.datedLogs) .then(() => {

                    })
                    .catch((error) => {
                        console.error("Error fetching crops");
                            console.log(error)
                    })
                },
            },
            computed: {
                componentReportRows() {
                    let tableRows = []
                    for(let log of this.datedLogs) {
                        let tableRow = {
                            id: log.data.crop_tid,
                            data: [
                                dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
                                log.area[0].name,
                                log.quantity[0].value,
                                log.quantity[0].unit.name,
                                this.idToCropMap.get(log.data.crop_tid)
                            ]
                        }
                        if(this.reportCrop=="All"){
                            tableRows.push(tableRow)
                        }
                        else if(tableRow.data[2]==this.selectedCrop){
                            tableRows.push(tableRow)
                        }
                    }
                    return tableRows
                },  

                cropNames(){
                    this.crops=Array.from(this.idToCropMap.values())
                    return Array.from(this.idToCropMap.values());
                },
            },
        });

        Vue.config.devtools = true;
    </script>
</body>
</html>
