<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vue Sub tab</title>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
    <script src="https://unpkg.com/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7"></script>
</head>
<body>
    <div id="report">
        <br>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
        <label for="reportTitle">Title</label>
        <input type="text" id="reportTitle" value="My Sample Harvest Report" v-model="reportTitle"/>
        <br><br>
        
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" :max="endDate" v-model="startDate">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate" :min="startDate" v-model="endDate">
        <br>
        <br>

        <label for="crops">Crops:</label>
         <select id="crops" name="crops" v-model="selectedCrop">
            <option v-for="crop in crops">{{crop}}</option>
            </select>
            <label for="area">Area:</label>
            <select id="area" name="area" v-model="selectedArea">
                <option v-for="area in areas">{{area}}</option>
            </select>
            <br>
            <br>
            <input type="button" value="Generate Report" v-on:click="generateReport"/>

        <hr>
        <div>
            <h1>{{ header ? header : "Mock Harvest Report" }}</h1>
            <p>Details:</p>
            <ul>
                <li><strong>Farm:</strong>{{farmName}}</li>
                <li><strong>User:</strong>{{userName}}</li>
                <li><strong>Language:</strong>{{userLanguage}}</li>
            </ul>
            <br>
            <ul>
                <li><strong>Start:</strong>{{startDate}}</li>
                <li><strong>End:</strong>{{endDate}}</li>
                <li><strong>Crop:</strong>{{selectedCrop}}</li>
            </ul>
            <table border="1" v-if="harvestReportRows.length > 0">
                <tr>
                    <th>Row</th>
                    <th>Date</th>
                    <th>Area</th>
                    <th>Crop</th>
                    <th>Yield</th>
                    <th>Units</th>
                </tr>
                <tr v-for="(log, index) in harvestReportRows" :key="log.date">
                    <td>{{index + 1}}</td>
                    <td>{{log.date}}</td>
                    <td>{{log.area}}</td>
                    <td>{{log.crop}}</td>
                    <td>{{log.yield}}</td>
                    <td>{{log.units}}</td>
                </tr>
            </table>
            <p v-else>No recorded data found.</p>
        </div>
    </div>

    <script>
        var harvestRepo = new Vue({
            el: '#report',
            data: {
                reportTitle: "My Sample Harvest Report",
                startDate: '',
                endDate: '',
                selectedCrop: 'Kale',
                selectedArea: '',
                crops: [],
                areas: ['All', 'Chuau-1', 'SQ7'],
                farmName: '',
                userName: '',
                userLanguage: '',
                idToCropMap: new Map(),
                harvestLogs: [],
                datedLogs: [],
            },

            created() {
                console.log("HarvestReport Vue instance created!");
                getCropToIDMap()
                    .then((theMap) => {
                        this.idToCropMap = theMap;
                        })   
                    .catch((error) => {
                        console.error("Error fetching crops");
                        console.log(error)
                    })
            },

            methods: {
                generateReport: function() {
                    this.harvestLogs.push({ date:"2020-05-05", area:"Orion-3", crop:"Peas", yield:"12", unit:"Bunches"});
                    axios.get('/farm.json')
                        .then(function (response) {

                            this.farmName = response.data.name;
                            this.userName = response.data.user.name;
                            this.userLanguage = response.data.user.language;
                        })
                        .catch((error) => {
                            console.error("Error fetching crops");
                            console.log(error)
                        })

                    let startDateTimestamp = dayjs(this.startDate).unix();
                    let endDateTimestamp = dayjs(this.endDate).unix();
                    console.log("Start Date Timestamp: ", startDateTimestamp);
                    console.log("End Date Timestamp: ", endDateTimestamp);
                    let request = `/log.json?type=farm_harvest&timestamp[ge]=${startDateTimestamp}&timestamp[le]=${endDateTimestamp}`;
                    console.log("API Request: ", request);
                    getAllPages(request, this.datedLogs) .then(() => {

                    })
                    .catch((error) => {
                        console.error("Error fetching crops");
                            console.log(error)
                    })
                },
            },
            computed: {
                cropNames(){
                    this.crops= Array.from(this.idToCropMap.values())
                },
                harvestReportRows(){
                    let tableRows = []
                    for(let log of this.datedLogs) {
                        let tableRow = {
                            date: dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
                            area: log.area[0].name,
                            yield: log.quantity[0].value,
                            units: log.quantity[0].unit.name,
                            crop: this.idToCropMap.get(log.data.crop_tid)
                        }
                        if(tableRow.crop==this.reportCrop){
                            tableRows.push(tableRow)
                        }
                    }
                    return tableRows
                },  
            },

        });

        Vue.config.devtools = true;
    </script>
</body>
</html>
