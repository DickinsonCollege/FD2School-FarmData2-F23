<body>
    <h1> Harvest Report </h1>
    <p> This page is a <i>mockup</i> of a simplified harvest report.</p>

    <div id="report" v-cloak>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="reportTitle">
        <br/>

        <label for="start">Start:</label>
        <input type="date" id="start" name="start" v-model="reportStartDate" min="2014-01-01" max="2022-01-01" :disabled="reportStartDate > reportEndDate" />
        <label for="end">End:</label>
        <input type="date" id="end" name="end" v-model="reportEndDate" min="2020-05-05" max="2022-01-01" />
        <br/>

        <label for="crop">Crop:</label>
        <select id="crop" name="crop" v-model="reportCrop">
            <option v-for="crop in cropNames"> {{crop}} </option>
        </select>

        <label for="field">Area:</label>
        <select id="field" name="field" v-model="reportField">
            <option v-for="field in reportFields"> {{field}} </option>
        </select>
        <br/>

        <button type="button" @click='generateReport'>Generate Report</button>
        <hr/>


        <h1>{{ reportTitle ? reportTitle : 'Mock Harvest Report' }}</h1>

        <p>Details: </p>
        <ul>
            <li><strong>Farm:</strong>{{ farm }}</li>
            <li><strong>User:</strong>{{ user }}</li>
            <li><strong>Language:</strong>{{ language }}</li>
            <br/>
            <li><strong>Start:</strong>{{ reportStartDate }}</li>
            <li><strong>End:</strong>{{ reportEndDate }}</li>
            <li><strong>Crop:</strong>{{ reportCrop }}</li>
        </ul>

        <table border=1>
            <tr v-if="harvestReportRows.length != 0">
                <th>Row</th>
                <th>Date</th>
                <th>Area</th>
                <th>Crop</th>
                <th>Yield</th>
                <th>Units</th>
            </tr>

            <p v-if="harvestReportRows.length == 0"> no harvest logs to be displayed </p>

            <tr v-for="(logs, index) in harvestReportRows"> <td>{{index + 1}}</td><td v-for="item in logs">{{item}}</td></tr>
        </table>
              
    </div>
    
    <script>
        var report = new Vue({
            el: '#report',
            created() {
                getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap = theMap
                })
                .catch((err) => {
                    console.log("Error Occurred")
                    console.log(error)
                })  
                console.log("HarvestReport Vue instance created!")
            },
            data: {
                reportTitle: 'My Sample Harvest Report',
                reportStartDate: '2020-05-05',
                reportEndDate: '2020-05-15',
                reportCrop: 'Kale',
                reportField: 'All',
                reportFields: [
                    'All',
                    'Chuau-1',
                    'SQ7'
                ],
                farm: '',
                user: '',
                language: '',
                idToCropMap: new Map(),
                getAllPagesResult: []
            },
            computed: {
                cropNames() {
                    return Array.from(this.idToCropMap.values());
                },
                harvestReportRows() {
                    let tableRows = []
                    for(let log of this.getAllPagesResult) {
                        let tableRow = {
                            date: dayjs.unix(log.timestamp).format("YYYY-MM-DD"),
                            area: log.area[0].name,
                            crop: this.idToCropMap.get(log.data.crop_tid),
                            yield: log.quantity[0].value,
                            units: log.quantity[0].unit.name
                        }
                        tableRows.push(tableRow)
                    }
                    return tableRows
                }
            },
            methods: {
                generateReport: function() {
                    axios.get('/farm.json')  // this line sends the request.
                    .then((response) => {
                        this.farm = response.data.name
                        this.user = response.data.user.name
                        this.language = response.data.languages.en.name
                        //^^ its pretty much hardcoded to english as of right now
                        reportStartDateTimeStamp = dayjs(this.reportStartDate).unix()
                        reportEndDateTimeStamp = dayjs(this.reportEndDate).unix()
                        requestEndpointWithQueryParams = '/log.json?type=farm_harvest&timestamp[ge]=' + reportStartDateTimeStamp + '&timestamp[le]=' + reportEndDateTimeStamp 
                        getAllPages(requestEndpointWithQueryParams)
                        .then((res) => {
                            this.getAllPagesResult = res
                        })
                        .catch((err) => {
                           console.log(err)
                        })
                    })
                    .catch((error) => {
                        console.log("Error Occurred")
                        console.log(error)
                    })
              }
            }
        })
        Vue.config.devtools = true;
    </script>
</body>